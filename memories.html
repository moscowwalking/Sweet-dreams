<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Memories ‚Äî –ö–∞—Ä—Ç–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    :root {
      --pink: #ff69b4;
      --hotpink: #ff1493;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #fff0f5, #ffeef8);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .leaflet-control-attribution {
      display: none !important;
    }
    .title {
      margin: 28px 0 6px;
      font-size: 2rem;
      color: #fff;
      text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.35);
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .title span {
      display: inline-block;
      transition: transform 0.25s ease;
    }
    .title span:hover {
      transform: scale(1.2);
      color: var(--pink);
    }
    #map {
      width: 92vw;
      max-width: 1000px;
      height: 80vh;
      max-height: 800px;
      border-radius: 12px;
      box-shadow: 0 8px 36px rgba(0, 0, 0, 0.24);
      overflow: hidden;
      position: relative;
    }
    .upload-panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 600;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .upload-btn {
      background: linear-gradient(90deg, var(--pink), var(--hotpink));
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    .drop-area {
      min-width: 220px;
      padding: 8px;
      border-radius: 8px;
      border: 2px dashed rgba(200, 200, 200, 0.6);
      text-align: center;
      font-size: 0.9rem;
      color: #444;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .drop-area.dragover {
      background: rgba(255, 240, 250, 0.8);
      border-color: var(--hotpink);
    }
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1200;
      align-items: center;
      justify-content: center;
    }
    .gallery {
      max-width: 92vw;
      max-height: 86vh;
      background: white;
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    .gallery .row {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .gallery img {
      max-width: 100%;
      max-height: 64vh;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
    }
    .thumbs {
      display: flex;
      gap: 8px;
      overflow: auto;
    }
    .thumbs img {
      display: none !important;
      width: 84px;
      height: 84px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .thumbs img.active {
      border-color: var(--pink);
      transform: scale(1.03);
    }
    @media (max-width: 640px) {
      .title {
        font-size: 1.5rem;
      }
      .drop-area {
        min-width: 150px;
        font-size: 0.85rem;
      }
      .thumbs img {
        width: 60px;
        height: 60px;
      }
    }
    .pulsing-marker {
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.6; }
      50% { transform: scale(1.15); opacity: 0.9; }
      100% { transform: scale(1); opacity: 0.6; }
    }


    .back-panel {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 700;
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: rgba(255, 255, 255, 0.9);
  padding: 6px 10px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  font-size: 0.9rem;
  color: #222;
}

.back-panel button {
  background: linear-gradient(90deg, var(--pink), var(--hotpink));
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
}
#photoCaption {
 text-align: center;
  margin-top: 10px;
  color: #333;
  font-style: italic;
  font-size: 15px;
  cursor: pointer;
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
  transition: opacity 0.5s ease;
}

.close-button {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 20px;
  height: 20px;
  background: var(--pink);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  transition: background 0.2s ease;
}

.close-button:hover {
  background: var(--hotpink);
  transform: scale(1.1);
}

.gallery {
  position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è */
  max-width: 92vw;
  max-height: 86vh;
  background: white;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.gallery-date {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: #444;
  margin: 0;
}

.photo-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
}

  </style>
</head>
<body>
  <h1 class="title">
    <span>–ö</span><span>–∞</span><span>—Ä</span><span>—Ç</span><span>–∞</span>
    <span> </span>
    <span>–≤</span><span>–æ</span><span>—Å</span><span>–ø</span><span>–æ</span><span>–º</span><span>–∏</span><span>–Ω</span><span>–∞</span><span>–Ω</span><span>–∏</span><span>–π</span>
  </h1>
  <div id="map">
    <div class="upload-panel" id="uploadPanel">
      <label class="upload-btn" for="fileInput">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
      <input id="fileInput" type="file" accept="image/*,image/heif,image/heic" multiple style="display:none">
      <div id="dropArea" class="drop-area">–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª</div>
    </div>
  </div>
<div class="button-wrapper" style="position:absolute;top:12px;left:12px;z-index:700;">
  <a href="index.html" class="main-button" style="background: linear-gradient(90deg, var(--pink), var(--hotpink));color:white;text-decoration:none;padding:6px 12px;border-radius:8px;font-weight:700;display:inline-block;">‚Üê –ù–∞–∑–∞–¥</a>
</div>
 <div id="overlay" class="overlay" aria-hidden="true">
  <div class="gallery" role="dialog" aria-modal="true">
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
    <button id="closeGallery" class="close-button">√ó</button>
    
    <!-- –î–∞—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
    <strong id="placeTitle" class="gallery-date">–ú–µ—Å—Ç–æ</strong>
    
    <!-- –§–æ—Ç–æ -->
    <div class="photo-container">
      <img id="galleryMain" src="" alt="–§–æ—Ç–æ">
    </div>
    
    <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
    <div class="thumbs" id="thumbs"></div>
  </div>
</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  <script>
    const map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 5);
    const SERVER_URL = 'https://sweet-dreams-f8nc.onrender.com';
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const markers = L.markerClusterGroup({
  showCoverageOnHover: false,   //  –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å–∏–Ω—é—é –ª–∏–Ω–∏—é
  spiderfyOnMaxZoom: true,      
  zoomToBoundsOnClick: true     
});
  map.addLayer(markers);
  const placesStore = new Map();

  function coordsKey(lat, lon, precision = 7) {
    return `${lat.toFixed(precision)},${lon.toFixed(precision)}`;
  }

  function waitImageLoad(url) {
    return new Promise(res => {
      const img = new Image();
      img.onload = () => res(true);
      img.onerror = () => res(false);
      img.src = url;
    });
  }

  async function renderPlaces(places) {
  markers.clearLayers();
  let skipped = 0;

  for (let place of places) {
    const photo = place.photos[0];
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (!photo.thumbUrl && !photo.origUrl) {
      skipped++;
      console.warn('‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –º–µ—Å—Ç–æ –±–µ–∑ —Ñ–æ—Ç–æ:', place.id);
      continue;
    }

    const url = photo.thumbUrl || photo.origUrl;
    const ok = await waitImageLoad(url);
    if (!ok) {
      skipped++;
      console.warn('‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–±–∏—Ç–∞—è —Å—Å—ã–ª–∫–∞):', url);
      continue;
    }

    const marker = createPlaceMarker(place);
    if (marker) {
      markers.addLayer(marker);
      placesStore.set(place.id, { ...place, marker });
    }
  }

  console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${places.length - skipped} –º–∞—Ä–∫–µ—Ä–æ–≤, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${skipped}`);
}

  let placesData = [];

  async function loadPlaces() {
  console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º places.json (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)...');

  const CACHE_KEY = 'places_cache_v3';
  const CACHE_TIME_KEY = 'places_cache_time_v3';
  const CACHE_TTL = 1000 * 60 * 5; // 5 –º–∏–Ω—É—Ç

  // --- 1. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–µ—à ---
  const cachedText = localStorage.getItem(CACHE_KEY);
  const cachedTime = parseInt(localStorage.getItem(CACHE_TIME_KEY), 10);

  const isCacheValid =
    cachedText &&
    cachedTime &&
    Date.now() - cachedTime < CACHE_TTL;

  if (isCacheValid) {
    console.log('‚ö° –ó–∞–≥—Ä—É–∂–∞–µ–º places.json –∏–∑ –∫–µ—à–∞');
    try {
      const data = JSON.parse(cachedText);
      return processPlaces(data);
    } catch (e) {
      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–µ—à–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ', e);
    }
  }

  // --- 2. –ì—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞ ---
  try {
    const url = 'https://storage.yandexcloud.net/sweet-dream-photos/backups/places.json?_=' + Date.now();
    const res = await fetch(url);

    if (!res.ok) {
      console.warn('‚ö†Ô∏è places.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –∫–µ—à');
      if (cachedText) processPlaces(JSON.parse(cachedText));
      return;
    }

    const text = await res.text();
    if (!text.trim()) {
      console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–π places.json, –ø—Ä–æ–±—É–µ–º –∫–µ—à');
      if (cachedText) processPlaces(JSON.parse(cachedText));
      return;
    }

    // --- 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–µ—à ---
    localStorage.setItem(CACHE_KEY, text);
    localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());

    const data = JSON.parse(text);
    processPlaces(data);

  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ places.json:', err);
    if (cachedText) {
      console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫–µ—à–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞');
      processPlaces(JSON.parse(cachedText));
    }
  }
}

// --- 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä ---
function processPlaces(data) {
  if (!Array.isArray(data)) {
    return console.warn('‚ö†Ô∏è places.json –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º');
  }

  const validData = data.filter(
    p =>
      (p.thumbUrl && p.thumbUrl.startsWith('http')) ||
      (p.origUrl && p.origUrl.startsWith('http'))
  );

  console.log(`‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö –º–µ—Å—Ç: ${validData.length} –∏–∑ ${data.length}`);

  const places = validData.map(p => {
    let displayDate = '';

    if (p.exifDate) {
      displayDate = p.exifDate;
    } else if (p.timestamp) {
      const date = new Date(p.timestamp);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear().toString().slice(-2);
      displayDate = `${day}.${month}.${year}`;
    }

    return {
      id: p.id,
      coords: p.coords,
      exifDate: p.exifDate,
      timestamp: p.timestamp,
      photos: [
        {
          thumbUrl: p.thumbUrl,
          origUrl: p.origUrl,
          date: displayDate,
          caption: p.caption || ''
        }
      ]
    };
  });

  renderPlaces(places);
}

  loadPlaces();
    
        function createPlaceMarker(place, isTemp = false) {
          
      const [lat, lon] = place.coords;
      const size = isTemp ? 40 : 56;
      const opacity = isTemp ? 0.5 : 1;
      const pulseClass = isTemp ? 'pulsing-marker' : '';
      const iconHtml = `
        <div class="${pulseClass}" style="display:flex;align-items:center;gap:6px;">
          <img src="${place.photos[0].thumbUrl}" style="width:${size}px;height:${size}px;border-radius:10px;object-fit:cover;opacity:${opacity}; box-shadow:0 6px 16px rgba(0,0,0,0.18)">
          <div style="background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:8px; font-weight:700;color:#222;">${place.photos.length}</div>
        </div>
      `;
      const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [160, 60] });
      const marker = L.marker([lat, lon], { icon });
      marker.on('click', () => openGallery(place));
      return marker;
    }

    const overlay = document.getElementById('overlay');
    const galleryMain = document.getElementById('galleryMain');
    const thumbs = document.getElementById('thumbs');
    const placeTitleEl = document.getElementById('placeTitle');

function openGallery(place) {
  console.log('üîç FULL PLACE DATA:', place);
  console.log('üîç Place exifDate:', place.exifDate);
  console.log('üîç First photo:', place.photos[0]);
  const overlay = document.getElementById('overlay');
  const galleryMain = document.getElementById('galleryMain');
  const thumbs = document.getElementById('thumbs');
  const placeTitleEl = document.getElementById('placeTitle');

  thumbs.innerHTML = '';

  const photoList = Array.isArray(place.photos) && place.photos.length
    ? place.photos
    : [{ 
        origUrl: place.origUrl, 
        thumbUrl: place.thumbUrl, 
        date: place.date || (place.timestamp ? new Date(place.timestamp).toLocaleDateString('ru-RU') : ''), 
        caption: place.caption || '' // –£–ë–ò–†–ê–ï–ú place.placeTitle –æ—Ç—Å—é–¥–∞
      }];

  const first = photoList[0];
  const src = first?.origUrl || first?.thumbUrl || '';
  if (!src) return;
  
  galleryMain.src = src;

   const dateText = first?.date || '–ë–µ–∑ –¥–∞—Ç—ã';
  placeTitleEl.textContent = dateText;
  
  
  
  placeTitleEl.textContent = dateText;

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–¥–ø–∏—Å—å
  let captionEl = document.getElementById('photoCaption');
  if (captionEl) captionEl.remove();

  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å
  captionEl = document.createElement('div');
  captionEl.id = 'photoCaption';
  captionEl.style.textAlign = 'center';
  captionEl.style.marginTop = '12px';
  captionEl.style.color = '#333';
  captionEl.style.fontStyle = 'italic';
  captionEl.style.fontSize = '15px';
  captionEl.style.cursor = 'pointer';
  captionEl.style.maxWidth = '90%';
  captionEl.style.marginLeft = 'auto';
  captionEl.style.marginRight = 'auto';
  captionEl.style.transition = 'opacity 0.3s ease';
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ñ–æ—Ç–æ
  const photoContainer = galleryMain.parentElement;
  photoContainer.parentNode.insertBefore(captionEl, photoContainer.nextSibling);

  let currentIndex = 0;
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ caption, –Ω–µ placeTitle
  const initialCaption = first.caption || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';
  captionEl.textContent = initialCaption;

  captionEl.onclick = () => {
  const oldText = captionEl.textContent === '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è' ? '' : captionEl.textContent;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = oldText;
  input.style.display = 'block';
  input.style.margin = '10px auto';
  input.style.width = '80%';
  input.style.textAlign = 'center';
  input.style.fontSize = '15px';
  input.style.padding = '6px';
  input.style.borderRadius = '10px';
  input.style.border = '1px solid #ccc';

  // –ó–∞–º–µ–Ω—è–µ–º captionEl –Ω–∞ input
  if (captionEl.parentNode) {
    captionEl.replaceWith(input);
  } else {
    const photoContainer = galleryMain.parentElement;
    photoContainer.parentNode.insertBefore(input, photoContainer.nextSibling);
  }
  
  input.focus();
  input.select();


   const finish = async () => {
  const newCaption = input.value.trim();
  photoList[currentIndex].caption = newCaption;
  
  // –ü–†–û–í–ï–†–Ø–ï–ú, —á—Ç–æ input –≤—Å–µ –µ—â–µ –≤ DOM –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π
  if (input.parentNode) {
    input.replaceWith(captionEl);
  } else {
    // –ï—Å–ª–∏ input —É–∂–µ —É–¥–∞–ª–µ–Ω, –ø—Ä–æ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º captionEl
    const photoContainer = galleryMain.parentElement;
    photoContainer.parentNode.insertBefore(captionEl, photoContainer.nextSibling);
  }
  
  captionEl.textContent = newCaption || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';
  captionEl.style.opacity = '0.6';
  setTimeout(() => (captionEl.style.opacity = '1'), 300);

  try {
    const payload = {
      id: place.id,
      photoIndex: currentIndex,
      caption: newCaption
    };
    const resp = await fetch(`${SERVER_URL}/update-caption`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML –≤–º–µ—Å—Ç–æ JSON
    const contentType = resp.headers.get('content-type');
    let data;
    if (contentType && contentType.includes('application/json')) {
      data = await resp.json();
    } else {
      const text = await resp.text();
      throw new Error(`Server returned ${resp.status}: ${text.substring(0, 100)}`);
    }
    
    if (!resp.ok || !data.success) {
      throw new Error(data.error || `server responded ${resp.status}`);
    }
    console.log('‚úÖ –ü–æ–¥–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    try {
      const st = placesStore.get(place.id);
      if (st) {
        if (Array.isArray(st.photos) && st.photos[currentIndex]) {
          st.photos[currentIndex].caption = newCaption;
        } else {
          st.caption = newCaption;
        }
        placesStore.set(place.id, st);
      }
    } catch (e) { /* –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ */ }
  } catch (err) {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å:', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å: ' + (err.message || err));
  }
};

    input.addEventListener('blur', finish);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') finish();
      if (e.key === 'Escape') {
        input.replaceWith(captionEl);
        captionEl.textContent = oldText || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';
      }
    });
  };

  overlay.style.display = 'flex';
}



    document.getElementById('closeGallery').onclick = () => overlay.style.display = 'none';

    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover'].forEach(ev => dropArea.addEventListener(ev, e => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    }));

    ['dragleave', 'drop'].forEach(ev => dropArea.addEventListener(ev, e => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
    }));

    dropArea.addEventListener('drop', e => handleFiles(Array.from(e.dataTransfer.files)));
    fileInput.addEventListener('change', e => {
      handleFiles(Array.from(e.target.files));
      fileInput.value = '';
    });

    async function handleFiles(files) {
  for (let file of files) {
    let gps = null;
    let exifDate = null;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º EXIF –¥–∞–Ω–Ω—ã–µ
    try {
      const exifData = await exifr.parse(file);
      console.log('üîç EXIF –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:', exifData);
      
      if (exifData && exifData.DateTimeOriginal) {
        const date = new Date(exifData.DateTimeOriginal);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        exifDate = `${day}.${month}.${year}`;
        console.log('‚úÖ EXIF –¥–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞:', exifDate);
      }
    } catch (exifErr) {
      console.log('‚ö†Ô∏è EXIF –¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', exifErr.message);
    }

    try {
      gps = await exifr.gps(file);
    } catch {}

    const isHEIC = /heic|heif/i.test(file.type) || /\.(heic|heif)$/i.test(file.name);
    if (isHEIC) {
      try {
        const converted = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.9 });
        file = new File([converted], 'converted.jpg', { type: 'image/jpeg' });
        console.log('‚úÖ HEIC converted to JPG');
      } catch (err) {
        console.error('HEIC convert failed', err);
      }
    }
    const coords = gps && gps.latitude && gps.longitude
      ? [gps.latitude, gps.longitude]
      : await waitForMapClick();

    if (!coords) continue;
    const tempPlace = {
      id: 'tmp-' + Date.now(),
      coords,
      photos: [{ 
        thumbUrl: URL.createObjectURL(file), 
        origUrl: URL.createObjectURL(file),
        date: exifDate || new Date().toLocaleDateString('ru-RU'), 
        caption: '' 
      }]
    };

    const tmpMarker = createPlaceMarker(tempPlace, true);
    markers.addLayer(tmpMarker);
    
    
    await uploadFileToServer(file, gps, tempPlace, tmpMarker, exifDate);
  }
}
    function waitForMapClick() {
      return new Promise(res => {
        const onClick = e => {
          map.off('click', onClick);
          res([e.latlng.lat, e.latlng.lng]);
        };
        map.on('click', onClick);
        setTimeout(() => {
          map.off('click', onClick);
          res(null);
        }, 30000);
      });
    }

    async function uploadFileToServer(file, gps, tmpPlace, tmpMarker, exifDate) {
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', file.name, file.size + 'B');

    const key = coordsKey(...tmpPlace.coords);

    try {
      const fd = new FormData();
      fd.append('file', file);
      fd.append('coords', JSON.stringify(tmpPlace.coords));
      fd.append('placeTitle', '–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ');
      
  
      if (exifDate) {
        fd.append('exifDate', exifDate);
      }

      const r = await fetch('https://sweet-dreams-f8nc.onrender.com/upload', {
        method: 'POST',
        body: fd
      });

      console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å—Ç–∞—Ç—É—Å:', r.status);
      const res = await r.json().catch(() => ({ success: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞' }));

      if (!res.success) throw new Error(res.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');

      console.log('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω:', res.fileUrl);

      markers.removeLayer(tmpMarker);
      const key = coordsKey(...tmpPlace.coords);
      let place = placesStore.get(key);
      if (!place) {
        place = { 
          id: key, 
          coords: [...tmpPlace.coords], 
          photos: [],
          exifDate: exifDate 
        };
        placesStore.set(key, place);
      }
      place.photos.push({ 
        thumbUrl: res.fileUrl, 
        origUrl: res.fileUrl,
        date: exifDate || new Date().toLocaleDateString('ru-RU') 
      });

      if (place.marker) markers.removeLayer(place.marker);
      place.marker = createPlaceMarker(place);
      markers.addLayer(place.marker);

      console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ –∫–∞—Ä—Ç–µ');
    } catch (e) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', e);
      markers.removeLayer(tmpMarker);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + e.message);
    }
  }

  function updateMarkerSizes() {
      const zoom = map.getZoom();
      const scale = Math.pow(2, zoom - 13);
      const size = Math.max(20, Math.min(56, 40 * scale));
      placesStore.forEach(place => {
        if (!place.marker) return;
        const iconHtml = `
          <div style="display:flex;align-items:center;gap:6px;">
            <img src="${place.photos[0].thumbUrl}" style="width:${size}px;height:${size}px;border-radius:10px;object-fit:cover;box-shadow:0 6px 16px rgba(0,0,0,0.18)">
            <div style="background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:8px;font-weight:700;color:#222;">${place.photos.length}</div>
          </div>
        `;
        const icon = L.divIcon({
          html: iconHtml,
          className: '',
          iconSize: [size + 50, size],
          iconAnchor: [size / 2, size / 2]
        });
        place.marker.setIcon(icon);
      });
}

    map.on('zoom', updateMarkerSizes);


    
  </script>
</body>
</html>