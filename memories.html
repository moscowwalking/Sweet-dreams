<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Memories ‚Äî –ö–∞—Ä—Ç–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  
  <style>
    /* ===== CSS Variables ===== */
    :root {
      --pink: #ff69b4;
      --hotpink: #ff1493;
      --gradient-pink: linear-gradient(90deg, var(--pink), var(--hotpink));
      --shadow-default: 0 6px 18px rgba(0, 0, 0, 0.12);
      --shadow-large: 0 20px 60px rgba(0, 0, 0, 0.5);
      --border-radius: 10px;
      --transition-default: 0.3s ease;
    }

    /* ===== Base Styles ===== */
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #fff0f5, #ffeef8);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* ===== Typography ===== */
    .title {
      margin: 28px 0 6px;
      font-size: 2rem;
      color: #fff;
      text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.35);
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .title span {
      display: inline-block;
      transition: transform 0.25s ease;
    }
    .title span:hover {
      transform: scale(1.2);
      color: var(--pink);
    }

    /* ===== Map ===== */
    #map {
      width: 92vw;
      max-width: 1000px;
      height: 80vh;
      max-height: 800px;
      border-radius: 12px;
      box-shadow: 0 8px 36px rgba(0, 0, 0, 0.24);
      overflow: hidden;
      position: relative;
    }

    /* ===== Upload Panel ===== */
    .upload-panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 600;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-default);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .upload-btn {
      background: var(--gradient-pink);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    .drop-area {
      min-width: 220px;
      padding: 8px;
      border-radius: 8px;
      border: 2px dashed rgba(200, 200, 200, 0.6);
      text-align: center;
      font-size: 0.9rem;
      color: #444;
      transition: all 0.15s ease;
    }
    .drop-area.dragover {
      background: rgba(255, 240, 250, 0.8);
      border-color: var(--hotpink);
    }

    /* ===== Navigation ===== */
    .nav-wrapper {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 700;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .nav-button {
      background: var(--gradient-pink);
      color: white;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 700;
      display: inline-block;
      transition: transform 0.2s;
    }
    .nav-button:hover {
      transform: scale(1.05);
    }

    /* ===== Love Counter ===== */
    .love-counter {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: var(--shadow-default);
      border: 2px solid rgba(255, 105, 180, 0.3);
      z-index: 700;
      animation: slideDown 0.5s ease-out;
    }
    .counter-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .counter-value {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #ff69b4, #ff1493);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
      transition: transform 0.3s;
    }
    .counter-value.updated {
      transform: scale(1.3);
    }
    .counter-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .counter-divider {
      font-size: 20px;
      color: #ff69b4;
      animation: heartbeat 1.5s infinite;
    }

    /* ===== Random Memory Button ===== */
    .random-memory-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      color: white;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 3px solid rgba(255,255,255,0.5);
      animation: popIn 0.5s ease-out;
    }
    .random-memory-btn:hover {
      transform: scale(1.1) rotate(180deg);
      box-shadow: 0 6px 25px rgba(255, 105, 180, 0.4);
    }
    .random-memory-btn:active {
      transform: scale(0.95);
    }

    /* ===== Gallery Overlay ===== */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1200;
      align-items: center;
      justify-content: center;
    }
    .gallery {
      position: relative;
      max-width: 92vw;
      max-height: 86vh;
      background: white;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow-large);
    }
    .close-button {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 30px;
      height: 30px;
      background: var(--pink);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 10;
    }
    .close-button:hover {
      background: var(--hotpink);
      transform: scale(1.1);
    }
    .gallery-date {
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      color: #444;
      margin: 0;
    }
    .photo-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    .gallery img {
      max-width: 100%;
      max-height: 64vh;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
    }
    .thumbs {
      display: flex;
      gap: 8px;
      overflow: auto;
    }
    .thumbs img {
      width: 84px;
      height: 84px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s;
    }
    .thumbs img:hover {
      transform: scale(1.05);
    }
    .thumbs img.active {
      border-color: var(--pink);
      transform: scale(1.03);
    }
    #photoCaption {
      text-align: center;
      margin-top: 10px;
      color: #333;
      font-style: italic;
      font-size: 15px;
      cursor: pointer;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
      transition: opacity 0.5s ease;
    }

    /* ===== Marker Styles ===== */
    .pulsing-marker {
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.6; }
      50% { transform: scale(1.15); opacity: 0.9; }
      100% { transform: scale(1); opacity: 0.6; }
    }
    @keyframes slideDown {
      0% { transform: translateY(-100px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes heartbeat {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    @keyframes popIn {
      0% { transform: scale(0); opacity: 0; }
      80% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .title { font-size: 1.5rem; }
      .drop-area { min-width: 150px; font-size: 0.85rem; }
      .thumbs img { width: 60px; height: 60px; }
      .love-counter { padding: 5px 12px; }
      .counter-value { font-size: 18px; }
      .counter-label { font-size: 9px; }
    }

    /* Utility */
    .hidden { display: none !important; }
    .leaflet-control-attribution { display: none !important; }
  </style>
</head>
<body>
  <h1 class="title">
    <span>–ö</span><span>–∞</span><span>—Ä</span><span>—Ç</span><span>–∞</span>
    <span> </span>
    <span>–≤</span><span>–æ</span><span>—Å</span><span>–ø</span><span>–æ</span><span>–º</span><span>–∏</span><span>–Ω</span><span>–∞</span><span>–Ω</span><span>–∏</span><span>–π</span>
  </h1>

  <div id="map">
    <div class="upload-panel" id="uploadPanel">
      <label class="upload-btn" for="fileInput">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
      <input id="fileInput" type="file" accept="image/*,image/heif,image/heic" multiple style="display:none">
      <div id="dropArea" class="drop-area">–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª</div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-wrapper">
    <a href="index.html" class="nav-button">‚Üê –ù–∞–∑–∞–¥</a>
  </div>

  <!-- Love Counter -->
  <div class="love-counter" id="loveCounter">
    <div class="counter-item">
      <span class="counter-value" id="totalMemories">0</span>
      <span class="counter-label">–≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</span>
    </div>
    <div class="counter-divider">‚ù§Ô∏è</div>
    <div class="counter-item">
      <span class="counter-value" id="totalDays">0</span>
      <span class="counter-label">–¥–Ω–µ–π –≤–º–µ—Å—Ç–µ</span>
    </div>
  </div>

  <!-- Gallery Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="gallery" role="dialog" aria-modal="true">
      <button id="closeGallery" class="close-button">√ó</button>
      <strong id="placeTitle" class="gallery-date">–ú–µ—Å—Ç–æ</strong>
      <div class="photo-container">
        <img id="galleryMain" src="" alt="–§–æ—Ç–æ">
      </div>
      <div class="thumbs" id="thumbs"></div>
    </div>
  </div>

  <!-- Random Memory Button -->
  <div class="random-memory-btn" id="randomMemoryBtn" title="–°–ª—É—á–∞–π–Ω–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ">üé≤</div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  
  <script>
    // =========================================================================
    // CONFIGURATION
    // =========================================================================
    const CONFIG = {
      SERVER_URL: 'https://sweet-dreams-f8nc.onrender.com',
      MAP: {
        center: [55.75, 37.61],
        zoom: 5,
        maxZoom: 19
      },
      CACHE: {
        PLACES_KEY: 'places_cache_v3',
        PLACES_TIME_KEY: 'places_cache_time_v3',
        TTL: 1000 * 60 * 60 * 2, // 2 —á–∞—Å–∞
        BROKEN_LINK_TTL: 1000 * 60 * 60 // 1 —á–∞—Å
      },
      RELATIONSHIP: {
        startDate: new Date(2025, 7, 23) // 23 –∞–≤–≥—É—Å—Ç–∞ 2025
      },
      MARKER: {
        size: 56,
        tempSize: 40,
        colors: ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a']
      },
      UPLOAD: {
        maxSize: 15 * 1024 * 1024 // 15MB
      }
    };

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    const map = L.map('map', { zoomControl: false }).setView(CONFIG.MAP.center, CONFIG.MAP.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: CONFIG.MAP.maxZoom }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const markers = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      zoomToBoundsOnClick: true,
      spiderfyDistanceMultiplier: 2.5
    });
    map.addLayer(markers);

    const placesStore = new Map();
    const brokenLinkCache = new Map();

    // =========================================================================
    // UTILITY FUNCTIONS
    // =========================================================================
    const Utils = {
      coordsKey(lat, lon, precision = 7) {
        return `${lat.toFixed(precision)},${lon.toFixed(precision)}`;
      },

      isElementInViewport(el, offset = 100) {
        if (!el) return false;
        const rect = el.getBoundingClientRect();
        return (
          rect.top >= -offset &&
          rect.left >= -offset &&
          rect.bottom <= (window.innerHeight + offset) &&
          rect.right <= (window.innerWidth + offset)
        );
      },

      async waitForMapClick(timeout = 30000) {
        return new Promise(resolve => {
          const onClick = e => {
            map.off('click', onClick);
            resolve([e.latlng.lat, e.latlng.lng]);
          };
          map.on('click', onClick);
          setTimeout(() => {
            map.off('click', onClick);
            resolve(null);
          }, timeout);
        });
      },

      formatDate(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${day}.${month}.${year}`;
      },

      getColorFromId(id) {
        const colors = CONFIG.MARKER.colors;
        const index = parseInt(id, 10) % colors.length || 0;
        return colors[index];
      }
    };

    // =========================================================================
    // IMAGE HANDLING
    // =========================================================================
    const ImageManager = {
  async waitForLoad(url, timeout = 5000) {
    return new Promise(resolve => {
      const img = new Image();
      const timer = setTimeout(() => {
        cleanup();
        resolve(false);
      }, timeout);

      const cleanup = () => {
        clearTimeout(timer);
        img.onload = null;
        img.onerror = null;
      };

      img.onload = () => {
        cleanup();
        resolve(true);
      };
      img.onerror = () => {
        cleanup();
        resolve(false);
      };
      img.src = url;
    });
  }
};

    // =========================================================================
    // MARKER HANDLING
    // =========================================================================
    const MarkerManager = {
  create(place, isTemp = false) {
    const [lat, lon] = place.coords;
    const size = isTemp ? CONFIG.MARKER.tempSize : CONFIG.MARKER.size;
    const opacity = isTemp ? 0.5 : 1;
    const pulseClass = isTemp ? 'pulsing-marker' : '';

    const iconHtml = `
      <div class="${pulseClass}" style="display:flex;align-items:center;gap:6px;">
        <img src="${place.photos[0].thumbUrl}" 
             style="width:${size}px;height:${size}px;border-radius:10px;object-fit:cover;opacity:${opacity}; box-shadow:0 6px 16px rgba(0,0,0,0.18)">
        <div style="background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:8px; font-weight:700;color:#222;">${place.photos.length}</div>
      </div>
    `;

    const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [160, 60] });
    const marker = L.marker([lat, lon], { icon });
    marker.on('click', () => Gallery.open(place));
    return marker;
  },

  updateSizes() {
    const zoom = map.getZoom();
    const scale = Math.pow(2, zoom - 13);
    const size = Math.max(20, Math.min(56, 40 * scale));

    placesStore.forEach(place => {
      if (!place.marker) return;
      const iconHtml = `
        <div style="display:flex;align-items:center;gap:6px;">
          <img src="${place.photos[0].thumbUrl}" 
               style="width:${size}px;height:${size}px;border-radius:10px;object-fit:cover;box-shadow:0 6px 16px rgba(0,0,0,0.18)">
          <div style="background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:8px;font-weight:700;color:#222;">${place.photos.length}</div>
        </div>
      `;
      const icon = L.divIcon({
        html: iconHtml,
        className: '',
        iconSize: [size + 50, size],
        iconAnchor: [size / 2, size / 2]
      });
      place.marker.setIcon(icon);
    });
  }
};

    // =========================================================================
    // GALLERY
    // =========================================================================
    const Gallery = {
      overlay: document.getElementById('overlay'),
      main: document.getElementById('galleryMain'),
      thumbs: document.getElementById('thumbs'),
      placeTitle: document.getElementById('placeTitle'),
      closeBtn: document.getElementById('closeGallery'),
      
      currentPlace: null,
      currentIndex: 0,

      init() {
        this.closeBtn.onclick = () => this.close();
      },

      open(place) {
        this.currentPlace = place;
        this.currentIndex = 0;
        this.thumbs.innerHTML = '';

        const photoList = Array.isArray(place.photos) && place.photos.length
          ? place.photos
          : [{
            origUrl: place.origUrl,
            thumbUrl: place.thumbUrl,
            date: place.date || (place.timestamp ? new Date(place.timestamp).toLocaleDateString('ru-RU') : ''),
            caption: place.caption || ''
          }];

        const first = photoList[0];
        const src = first?.origUrl || first?.thumbUrl || '';
        if (!src) return;

        this.main.src = src;
        this.placeTitle.textContent = first?.date || '–ë–µ–∑ –¥–∞—Ç—ã';
        
        this.createCaptionElement(first.caption);
        this.overlay.style.display = 'flex';
      },

      close() {
        this.overlay.style.display = 'none';
      },

      createCaptionElement(initialCaption) {
        let captionEl = document.getElementById('photoCaption');
        if (captionEl) captionEl.remove();

        captionEl = document.createElement('div');
        captionEl.id = 'photoCaption';
        captionEl.textContent = initialCaption || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';
        captionEl.onclick = () => this.editCaption(captionEl);

        const photoContainer = this.main.parentElement;
        photoContainer.parentNode.insertBefore(captionEl, photoContainer.nextSibling);
      },

      async editCaption(captionEl) {
        const oldText = captionEl.textContent === '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è' ? '' : captionEl.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldText;
        Object.assign(input.style, {
          display: 'block',
          margin: '10px auto',
          width: '80%',
          textAlign: 'center',
          fontSize: '15px',
          padding: '6px',
          borderRadius: '10px',
          border: '1px solid #ccc'
        });

        captionEl.replaceWith(input);
        input.focus();
        input.select();

        const finish = async () => {
          const newCaption = input.value.trim();
          const photoList = Array.isArray(this.currentPlace.photos) 
            ? this.currentPlace.photos 
            : [this.currentPlace];
          
          photoList[this.currentIndex].caption = newCaption;

          input.replaceWith(captionEl);
          captionEl.textContent = newCaption || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';

          try {
            await fetch(`${CONFIG.SERVER_URL}/update-caption`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: this.currentPlace.id,
                photoIndex: this.currentIndex,
                caption: newCaption
              })
            });
          } catch (err) {
            console.error('Failed to save caption:', err);
          }
        };

        input.addEventListener('blur', finish);
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') finish();
          if (e.key === 'Escape') {
            input.replaceWith(captionEl);
            captionEl.textContent = oldText || '–î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å ‚úçÔ∏è';
          }
        });
      }
    };

    // =========================================================================
    // LOVE COUNTER
    // =========================================================================
    const LoveCounter = {
      memoriesEl: document.getElementById('totalMemories'),
      daysEl: document.getElementById('totalDays'),
      counterEl: document.getElementById('loveCounter'),
      watchInterval: null,
      
      init() {
        this.update();
        this.startWatching();
      },

      update() {
        const totalMemories = placesStore.size;
        const oldValue = parseInt(this.memoriesEl.textContent) || 0;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        if (totalMemories !== oldValue) {
          this.memoriesEl.classList.add('updated');
          setTimeout(() => this.memoriesEl.classList.remove('updated'), 300);
        }
        
        this.memoriesEl.textContent = totalMemories;

        const startDate = CONFIG.RELATIONSHIP.startDate;
        const today = new Date();
        const diffTime = Math.abs(today - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        this.daysEl.textContent = diffDays;

        const years = Math.floor(diffDays / 365);
        const months = Math.floor((diffDays % 365) / 30);
        const days = diffDays % 30;
        this.counterEl.title = `–í–º–µ—Å—Ç–µ —É–∂–µ ${years} –ª–µ—Ç, ${months} –º–µ—Å—è—Ü–µ–≤ –∏ ${days} –¥–Ω–µ–π ‚ù§Ô∏è`;
      },

      startWatching() {
        let lastCount = placesStore.size;
        
        this.watchInterval = setInterval(() => {
          const currentCount = placesStore.size;
          if (currentCount !== lastCount) {
            lastCount = currentCount;
            this.update();
          }
        }, 500);

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          if (this.watchInterval) {
            clearInterval(this.watchInterval);
            this.watchInterval = null;
          }
        }, 30000);
      }
    };

    // =========================================================================
    // RANDOM MEMORY
    // =========================================================================
    const RandomMemory = {
      btn: document.getElementById('randomMemoryBtn'),

      init() {
        this.btn.addEventListener('click', () => this.show());
      },

      show() {
        const places = Array.from(placesStore.values());
        
        if (places.length === 0) {
          alert('üò¢ –ü–æ–∫–∞ –Ω–µ—Ç –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π...');
          return;
        }

        const randomPlace = places[Math.floor(Math.random() * places.length)];
        
        map.flyTo(randomPlace.coords, 16, {
          duration: 2,
          easeLinearity: 0.5
        });

        setTimeout(() => Gallery.open(randomPlace), 1500);

        this.btn.style.transform = 'scale(1.2)';
        setTimeout(() => this.btn.style.transform = '', 300);
      }
    };

    // =========================================================================
    // UPLOAD MANAGER
    // =========================================================================
    const UploadManager = {
      dropArea: document.getElementById('dropArea'),
      fileInput: document.getElementById('fileInput'),

      init() {
        ['dragenter', 'dragover'].forEach(ev => {
          this.dropArea.addEventListener(ev, e => {
            e.preventDefault();
            this.dropArea.classList.add('dragover');
          });
        });

        ['dragleave', 'drop'].forEach(ev => {
          this.dropArea.addEventListener(ev, e => {
            e.preventDefault();
            this.dropArea.classList.remove('dragover');
          });
        });

        this.dropArea.addEventListener('drop', e => this.handleFiles(Array.from(e.dataTransfer.files)));
        this.fileInput.addEventListener('change', e => {
          this.handleFiles(Array.from(e.target.files));
          this.fileInput.value = '';
        });
      },

      async handleFiles(files) {
        for (const file of files) {
          await this.processFile(file);
        }
      },

      async processFile(file) {
        let gps = null;
        let exifDate = null;

        try {
          const exifData = await exifr.parse(file);
          if (exifData?.DateTimeOriginal) {
            const date = new Date(exifData.DateTimeOriginal);
            exifDate = Utils.formatDate(date);
          }
        } catch (exifErr) {
          console.log('No EXIF date found');
        }

        try {
          gps = await exifr.gps(file);
        } catch {}

        let processedFile = file;
        if (/heic|heif/i.test(file.type) || /\.(heic|heif)$/i.test(file.name)) {
          try {
            const converted = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.9 });
            processedFile = new File([converted], 'converted.jpg', { type: 'image/jpeg' });
          } catch (err) {
            console.error('HEIC convert failed', err);
          }
        }

        const coords = gps?.latitude && gps?.longitude
          ? [gps.latitude, gps.longitude]
          : await Utils.waitForMapClick();

        if (!coords) return;

        const tempPlace = {
          id: 'tmp-' + Date.now(),
          coords,
          photos: [{
            thumbUrl: URL.createObjectURL(processedFile),
            origUrl: URL.createObjectURL(processedFile),
            date: exifDate || Utils.formatDate(new Date()),
            caption: ''
          }]
        };

        const tmpMarker = MarkerManager.create(tempPlace, true);
        markers.addLayer(tmpMarker);
        
        await this.uploadToServer(processedFile, gps, tempPlace, tmpMarker, exifDate);
      },

      async uploadToServer(file, gps, tmpPlace, tmpMarker, exifDate) {
        try {
          const fd = new FormData();
          fd.append('file', file);
          fd.append('coords', JSON.stringify(tmpPlace.coords));
          fd.append('placeTitle', '–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ');
          if (exifDate) fd.append('exifDate', exifDate);

          const r = await fetch(`${CONFIG.SERVER_URL}/upload`, { method: 'POST', body: fd });
          const res = await r.json().catch(() => ({ success: false }));

          if (!res.success) throw new Error('Upload failed');

          markers.removeLayer(tmpMarker);
          
          const key = Utils.coordsKey(...tmpPlace.coords);
          let place = placesStore.get(key);
          
          if (!place) {
            place = {
              id: key,
              coords: [...tmpPlace.coords],
              photos: [],
              exifDate
            };
            placesStore.set(key, place);
          }
          
          place.photos.push({
            thumbUrl: res.fileUrl,
            origUrl: res.fileUrl,
            date: exifDate || Utils.formatDate(new Date())
          });

          if (place.marker) markers.removeLayer(place.marker);
          place.marker = MarkerManager.create(place);
          markers.addLayer(place.marker);

          LoveCounter.update();
        } catch (e) {
          console.error('Upload error:', e);
          markers.removeLayer(tmpMarker);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + e.message);
        }
      }
    };

    // =========================================================================
    // DATA LOADING
    // =========================================================================
    const DataLoader = {
  async load() {
    console.log('üì• Loading places.json...');

    const cachedText = localStorage.getItem(CONFIG.CACHE.PLACES_KEY);
    const cachedTime = parseInt(localStorage.getItem(CONFIG.CACHE.PLACES_TIME_KEY), 10);
    const isCacheValid = cachedText && cachedTime && Date.now() - cachedTime < CONFIG.CACHE.TTL;

    if (isCacheValid) {
      console.log('‚ö° Using cache');
      try {
        const data = JSON.parse(cachedText);
        await this.processData(data);
        return;
      } catch (e) {
        console.warn('Cache error:', e);
      }
    }

    try {
      const url = `https://storage.yandexcloud.net/sweet-dream-photos/backups/places.json?_=${Date.now()}`;
      const res = await fetch(url);
      
      if (!res.ok) throw new Error('Network error');
      
      const text = await res.text();
      const data = JSON.parse(text);
      
      localStorage.setItem(CONFIG.CACHE.PLACES_KEY, text);
      localStorage.setItem(CONFIG.CACHE.PLACES_TIME_KEY, Date.now().toString());
      
      await this.processData(data);
    } catch (err) {
      console.error('Load error:', err);
      if (cachedText) {
        console.log('üì¶ Using fallback cache');
        await this.processData(JSON.parse(cachedText));
      }
    }
  },

  async processData(data) {
    if (!Array.isArray(data)) {
      console.warn('Invalid data format');
      return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º –º–µ—Å—Ç–∞ –±–µ–∑ —Å—Å—ã–ª–æ–∫
    const validData = data.filter(p =>
      (p.thumbUrl?.startsWith('http')) || (p.origUrl?.startsWith('http'))
    );

    console.log(`‚úÖ Found ${validData.length} places with URLs`);

    const places = validData.map(p => ({
      id: p.id,
      coords: p.coords,
      exifDate: p.exifDate,
      timestamp: p.timestamp,
      photos: [{
        thumbUrl: p.thumbUrl,
        origUrl: p.origUrl,
        date: p.exifDate || (p.timestamp ? new Date(p.timestamp).toLocaleDateString('ru-RU') : ''),
        caption: p.caption || ''
      }]
    }));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ
    await this.renderWithCheck(places);
  },

  async renderWithCheck(places) {
    markers.clearLayers();
    
    let totalValid = 0;
    let totalSkipped = 0;
    
    console.log(`üîç Checking ${places.length} links...`);

    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    const batchSize = 20;
    for (let i = 0; i < places.length; i += batchSize) {
      const batch = places.slice(i, i + batchSize);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      const results = await Promise.all(
        batch.map(async (place) => {
          const photo = place.photos[0];
          const url = photo.thumbUrl || photo.origUrl;
          
          if (!url) return { place, valid: false };
          
          const isValid = await ImageManager.waitForLoad(url, 2000);
          return { place, valid: isValid };
        })
      );

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ
      for (const result of results) {
        if (result.valid) {
          const marker = MarkerManager.create(result.place);
          markers.addLayer(marker);
          placesStore.set(result.place.id, { ...result.place, marker });
          totalValid++;
        } else {
          totalSkipped++;
          console.log('üîó Skipped broken link:', result.place.photos[0].thumbUrl || result.place.photos[0].origUrl);
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      console.log(`‚è≥ Progress: ${i + batch.length}/${places.length}`);
      
      // –ú–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
      await new Promise(resolve => setTimeout(resolve, 50));
    }

    console.log(`‚úÖ Done: ${totalValid} valid, ${totalSkipped} broken`);
    LoveCounter.update();
  }
};
    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    function init() {
      Gallery.init();
      RandomMemory.init();
      UploadManager.init();
      LoveCounter.init();

      DataLoader.load();

      map.on('zoom', MarkerManager.updateSizes.bind(MarkerManager));
      map.on('moveend', () => setTimeout(MarkerManager.preloadVisibleMarkers.bind(MarkerManager), 300));

      // Patch upload function for counter update
      const originalUpload = UploadManager.uploadToServer.bind(UploadManager);
      UploadManager.uploadToServer = async (...args) => {
        await originalUpload(...args);
        LoveCounter.update();
      };
    }

    // Start everything
    init();
  </script>
</body>
</html>